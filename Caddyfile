{
	# Admin API — localhost only, no external exposure
	admin localhost:2019

	# Prometheus metrics — exposed via admin API at localhost:2019/metrics
	metrics

	email {$EMAIL}
	acme_dns cloudflare {$CF_API_TOKEN}
	cert_issuer acme
	grace_period 5s

	# Encrypted Client Hello — hides real SNI from ISP/eavesdroppers
	# Requires client DoH/DoT for full privacy benefit
	dns cloudflare {$CF_API_TOKEN}
	ech ech.erfi.io

	# Coraza WAF must run before other handlers
	order coraza_waf first

	log {
		level INFO
		output file /var/log/access.log {
			roll_size 1gb
			roll_keep 5
			roll_keep_for 168h
		}
		format json {
			time_format wall
		}
	}
	servers {
		strict_sni_host on
		protocols h1 h2 h3
		trusted_proxies static 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
	}
	dynamic_dns {
		provider cloudflare {$CF_API_TOKEN}
		domains {
			erfi.io authelia caddy servarr navidrome vault immich caddy-prometheus jellyfin sabnzbd radarr bazarr prowlarr sonarr joplin keycloak qbit change seerr copyparty dockge-sg
		}
		versions ipv4
		check_interval 1m
		ip_source upnp
		ip_source simple_http https://icanhazip.com
		ip_source simple_http https://api.ipify.org
		ip_source simple_http https://myip.addr.space
		ip_source simple_http https://ifconfig.me
		ip_source simple_http https://ident.me
		ip_source simple_http https://bot.whatismyipaddress.com
		ip_source simple_http https://ipecho.net/plain
	}
}

(cors) {
	@cors_preflight method OPTIONS
	handle @cors_preflight {
		header Access-Control-Allow-Origin "https://{http.request.host}"
		header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE"
		header Access-Control-Allow-Headers "Content-Type"
		header Access-Control-Max-Age "3600"
		respond "" 204
	}
	header Access-Control-Allow-Origin "https://{http.request.host}"
	header Vary Origin
}

# Static asset caching — sets Cache-Control only if the upstream didn't already.
# Respects upstream headers from apps that set their own (Jellyfin, Vaultwarden, Immich).
# Cloudflare edge and browsers both honour these.
# Usage: import static_cache
(static_cache) {
	@fonts path *.woff *.woff2 *.ttf *.eot *.otf
	header @fonts ?Cache-Control "public, max-age=31536000, immutable"

	@images path *.png *.jpg *.jpeg *.gif *.webp *.avif *.svg *.ico
	header @images ?Cache-Control "public, max-age=604800, stale-while-revalidate=86400"

	@styles path *.css
	header @styles ?Cache-Control "public, max-age=604800, stale-while-revalidate=86400"

	@scripts path *.js
	header @scripts ?Cache-Control "public, max-age=604800, stale-while-revalidate=86400"

	@media path *.mp3 *.mp4 *.flac *.mkv *.avi *.ogg *.opus *.wav *.aac *.webm
	header @media ?Cache-Control "public, max-age=2592000, stale-while-revalidate=86400"
}

# Global security headers — applied to every site via import
(security_headers) {
	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
		Cross-Origin-Opener-Policy "same-origin"
		Cross-Origin-Resource-Policy "same-origin"
		X-Permitted-Cross-Domain-Policies "none"
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https:; worker-src 'self' blob:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; font-src 'self' data: https:; connect-src 'self' wss: ws: https:; media-src 'self' blob: https:; frame-src 'self' https:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"
		-Server
		-X-Powered-By
	}
}

# Coraza WAF — OWASP Core Rule Set for inline request security
# Skips WebSocket upgrades (Coraza mangles the 101 handshake)
# Includes handle_errors for 400 (malformed body), 403 (WAF deny),
# and 429 (rate limit) so blocked requests get our custom error page.
(waf) {
	@not_websocket {
		not header Connection *Upgrade*
	}
	route @not_websocket {
		coraza_waf {
			load_owasp_crs
			directives `
			Include /etc/caddy/coraza/pre-crs.conf
			Include @crs-setup.conf.example
			Include @owasp_crs/*.conf
			Include /etc/caddy/coraza/post-crs.conf
			SecRuleEngine On
			SecAuditEngine RelevantOnly
			SecAuditLog /var/log/coraza-audit.log
			SecAuditLogFormat json
			`
		}
	}
	handle_errors 400 403 429 {
		root * /etc/caddy/errors
		templates
		rewrite * /error.html
		file_server
	}
}

# Configurable rate limit — per client IP, excludes WebSocket upgrades
# Sets X-RateLimit-Limit and X-RateLimit-Policy headers on all responses.
# The plugin automatically sets Retry-After on 429 responses.
# Usage: import rate_limit <zone_name> <events> <window>
# Example: import rate_limit sonarr 100 1m
(rate_limit) {
	rate_limit {
		zone {args[0]} {
			match {
				not header Connection *Upgrade*
			}
			key {http.request.remote.host}
			events {args[1]}
			window {args[2]}
		}
	}
	header X-RateLimit-Limit "{args[1]}"
	header X-RateLimit-Policy "{args[1]};w={args[2]};name=\"{args[0]}\""
}

# Common TLS config snippet
(tls_config) {
	tls {
		issuer acme {
			dns cloudflare {$CF_API_TOKEN}
			propagation_delay 60s
			propagation_timeout -1
			resolvers 1.1.1.1
		}
	}
}

# Standard log config — INFO level, per-site log file
(site_log) {
	log {
		level INFO
		output file /var/log/{args[0]}-access.log {
			roll_size 1gb
			roll_keep 5
			roll_keep_for 168h
		}
		format json {
			time_format wall
		}
	}
}

# IPsum blocklist — auto-generated file with @ipsum_blocked matcher + abort
# Updated daily by scripts/update-ipsum.sh via cron
# Usage: import ipsum_blocklist
(ipsum_blocklist) {
	import /etc/caddy/ipsum_block.caddy
}

# Authelia forward auth — applied to protected services
# Usage: import forward_auth
(forward_auth) {
	forward_auth 172.19.99.2:9091 {
		uri /api/authz/forward-auth
		copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
	}
}

# Common reverse proxy headers snippet
(proxy_headers) {
	trusted_proxies private_ranges
	header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
	header_down -Access-Control-Allow-Origin
	header_down -Access-Control-Allow-Methods
	header_down -Access-Control-Allow-Headers
	header_down -Access-Control-Max-Age
	header_down -Content-Security-Policy
}

# Custom error pages — serves /etc/caddy/errors/error.html with Caddy templates
# Covers remaining error codes not handled by the (waf) snippet.
# The (waf) snippet handles 403 and 429 specifically; this catches the rest
# (404, 500, 502, 503, 504, etc.)
# Usage: import error_pages
(error_pages) {
	handle_errors {
		root * /etc/caddy/errors
		templates
		rewrite * /error.html
		file_server
	}
}

# caddy.erfi.io — Admin API is localhost-only.
# Use `docker exec caddy caddy reload --config /etc/caddy/Caddyfile` to reload.
# Or SSH tunnel: ssh -L 2019:localhost:2019 user@host
caddy.erfi.io {
	import cors
	import security_headers
	import waf
	import ipsum_blocklist
	import rate_limit caddy 100 1m
	import tls_config
	encode zstd gzip
	respond "Caddy is running. Admin API available via localhost:2019 only." 200
	import error_pages
	import site_log caddy-api
}

authelia.erfi.io {
	import security_headers
	import static_cache
	import ipsum_blocklist
	import rate_limit authelia 200 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.99.2:9091 {
		import proxy_headers
	}
	import error_pages
	import site_log authelia
}

servarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit servarr 1000 1m
	import tls_config
	import forward_auth
	encode zstd gzip
	reverse_proxy localhost:90 {
		import proxy_headers
	}
	import error_pages
	import site_log servarr
}

sonarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit sonarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.3:8989 {
		import proxy_headers
	}
	import error_pages
	import site_log sonarr
}

radarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit radarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.2:7878 {
		import proxy_headers
	}
	import error_pages
	import site_log radarr
}

bazarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit bazarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.4:6767 {
		import proxy_headers
	}
	import error_pages
	import site_log bazarr
}

vault.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit vault 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy /notifications/hub 172.19.4.2:3012 {
		import proxy_headers
		header_up X-Real-IP {remote_host}
	}
	reverse_proxy 172.19.4.2:80 {
		import proxy_headers
		header_up X-Real-IP {remote_host}
	}
	import error_pages
	import site_log vaultwarden
}

prowlarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit prowlarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.10:9696 {
		import proxy_headers
	}
	import error_pages
	import site_log prowlarr
}

jellyfin.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit jellyfin 1000 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.15:8096 {
		import proxy_headers
	}
	import error_pages
	import site_log jellyfin
}

qbit.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit qbit 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.22:8080 {
		import proxy_headers
	}
	import error_pages
	import site_log qbit
}

change.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import forward_auth
	import rate_limit change 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.3.2:5000 {
		import proxy_headers
	}
	import error_pages
	import site_log change
}

seerr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit seerr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.21:5055 {
		import proxy_headers
	}
	import error_pages
	import site_log seerr
}

keycloak.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit keycloak 100 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.12.2:8080 {
		import proxy_headers
	}
	import error_pages
	import site_log keycloak
}

joplin.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit joplin 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.13.2:22300 {
		import proxy_headers
	}
	import error_pages
	import site_log joplin
}

navidrome.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit navidrome 1000 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.17:4533 {
		import proxy_headers
	}
	import error_pages
	import site_log navidrome
}

sabnzbd.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit sabnzbd 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.19:6666 {
		import proxy_headers
	}
	import error_pages
	import site_log sabnzbd
}

immich.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit immich 1000 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.22.2:2283 {
		import proxy_headers
	}
	import error_pages
	import site_log immich
}

caddy-prometheus.erfi.io {
	import cors
	import security_headers
	import waf
	import ipsum_blocklist
	import rate_limit caddy-prometheus 100 1m
	import tls_config
	import forward_auth
	encode zstd gzip
	reverse_proxy /metrics localhost:2019 {
		import proxy_headers
	}
	import error_pages
	import site_log caddy-prometheus
}

copyparty.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit copyparty 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.66.2:3923 {
		import proxy_headers
	}
	import error_pages
	import site_log copyparty
}

dockge-sg.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit dockge 100 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.17.0.2:5001 {
		import proxy_headers
	}
	import error_pages
	import site_log dockge
}
