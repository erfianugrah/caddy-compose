{
	# Admin API — localhost for healthcheck/metrics + Unix socket for waf-api reload
	admin localhost:2019

	# Prometheus metrics — exposed via admin API at localhost:2019/metrics
	metrics

	email {$EMAIL}
	acme_dns cloudflare {$CF_API_TOKEN}
	cert_issuer acme
	grace_period 5s

	# Encrypted Client Hello — hides real SNI from ISP/eavesdroppers
	# Requires client DoH/DoT for full privacy benefit
	dns cloudflare {$CF_API_TOKEN}
	ech ech.erfi.io

	# Coraza WAF must run before other handlers
	order coraza_waf first

	log {
		level INFO
		output file /var/log/access.log {
			roll_size 256mb
			roll_keep 5
			roll_keep_for 168h
		}
		format json {
			time_format wall
		}
	}
	servers {
		strict_sni_host on
		protocols h1 h2 h3
		import /etc/caddy/cf_trusted_proxies.caddy
	}
	dynamic_dns {
		provider cloudflare {$CF_API_TOKEN}
		domains {
			erfi.io authelia caddy waf servarr navidrome vault immich caddy-prometheus jellyfin sabnzbd radarr bazarr prowlarr sonarr joplin keycloak qbit change seerr copyparty dockge-sg httpbun httpbin
		}
		versions ipv4
		check_interval 5m
		ip_source upnp
		ip_source simple_http https://icanhazip.com
		ip_source simple_http https://api.ipify.org
		ip_source simple_http https://myip.addr.space
		ip_source simple_http https://ifconfig.me
		ip_source simple_http https://ident.me
		ip_source simple_http https://bot.whatismyipaddress.com
		ip_source simple_http https://ipecho.net/plain
	}
}

(cors) {
	@cors_preflight method OPTIONS
	handle @cors_preflight {
		header Access-Control-Allow-Origin "https://{http.request.host}"
		header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE"
		header Access-Control-Allow-Headers "Content-Type"
		header Access-Control-Max-Age "3600"
		respond "" 204
	}
	header Access-Control-Allow-Origin "https://{http.request.host}"
	header Vary Origin
}

# Static asset caching — sets Cache-Control only if the upstream didn't already.
# Respects upstream headers from apps that set their own (Jellyfin, Vaultwarden, Immich).
# Cloudflare edge and browsers both honour these.
# Usage: import static_cache
(static_cache) {
	@fonts path *.woff *.woff2 *.ttf *.eot *.otf
	header @fonts ?Cache-Control "public, max-age=31536000, immutable"

	@images path *.png *.jpg *.jpeg *.gif *.webp *.avif *.svg *.ico
	header @images ?Cache-Control "public, max-age=604800, stale-while-revalidate=86400"

	@styles path *.css
	header @styles ?Cache-Control "public, max-age=604800, stale-while-revalidate=86400"

	@scripts path *.js
	header @scripts ?Cache-Control "public, max-age=604800, stale-while-revalidate=86400"

	@media path *.mp3 *.mp4 *.flac *.mkv *.avi *.ogg *.opus *.wav *.aac *.webm
	header @media ?Cache-Control "public, max-age=2592000, stale-while-revalidate=86400"
}

# Global security headers — applied to every site via import
(security_headers) {
	header {
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
		Cross-Origin-Opener-Policy "same-origin"
		Cross-Origin-Resource-Policy "same-origin"
		X-Permitted-Cross-Domain-Policies "none"
		?Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https:; worker-src 'self' blob:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; font-src 'self' data: https:; connect-src 'self' wss: ws: https:; media-src 'self' blob: https:; frame-src 'self' https:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"
		-Server
		-X-Powered-By
	}
}

# Coraza WAF — OWASP CRS with three operational tiers.
# All tiers skip WebSocket upgrades (Coraza mangles the 101 handshake).
#
# (waf)          — Tuning mode: PL1, anomaly thresholds at 10000 (logs everything, blocks nothing).
# (waf_moderate) — Moderate mode: PL1, anomaly thresholds at 15/15 (blocks obvious attacks, tolerates API quirks).
# (waf_strict)   — Enforcing mode: PL1, anomaly thresholds at 5/4 (CRS defaults, blocks attacks).
# (waf_off)      — No WAF processing. For static-respond-only or metrics-only services.
#
# Each tier loads configs in order:
#   1. /etc/caddy/coraza/pre-crs.conf         — Baked-in defaults (image build)
#   2. /data/coraza/custom-pre-crs.conf       — Dynamic overrides (Policy Engine UI)
#   3. CRS setup + CRS rules
#   4. /etc/caddy/coraza/post-crs.conf        — Baked-in defaults (image build)
#   5. /data/coraza/custom-post-crs.conf      — Dynamic overrides (Policy Engine UI)

(waf) {
	@not_websocket {
		not header Connection *Upgrade*
	}
	route @not_websocket {
		coraza_waf {
			load_owasp_crs
			directives `
			Include /etc/caddy/coraza/pre-crs.conf
			Include /data/coraza/custom-pre-crs.conf
			Include @crs-setup.conf.example
			Include @owasp_crs/*.conf
			Include /etc/caddy/coraza/post-crs.conf
			Include /data/coraza/custom-post-crs.conf
			SecRuleEngine On
			SecAuditEngine RelevantOnly
			SecAuditLog /var/log/coraza-audit.log
			SecAuditLogFormat json
			SecAuditLogParts ABCFHZ
			SecAction "id:900000,phase:1,pass,t:none,nolog,setvar:tx.paranoia_level=1"
			SecAction "id:900110,phase:1,pass,t:none,nolog,setvar:tx.inbound_anomaly_score_threshold=10000,setvar:tx.outbound_anomaly_score_threshold=10000"
			`
		}
	}
	handle_errors 400 403 429 {
		root * /etc/caddy/errors
		templates
		rewrite * /error.html
		file_server
	}
}

(waf_moderate) {
	@not_websocket_moderate {
		not header Connection *Upgrade*
	}
	route @not_websocket_moderate {
		coraza_waf {
			load_owasp_crs
			directives `
			Include /etc/caddy/coraza/pre-crs.conf
			Include /data/coraza/custom-pre-crs.conf
			Include @crs-setup.conf.example
			Include @owasp_crs/*.conf
			Include /etc/caddy/coraza/post-crs.conf
			Include /data/coraza/custom-post-crs.conf
			SecRuleEngine On
			SecAuditEngine RelevantOnly
			SecAuditLog /var/log/coraza-audit.log
			SecAuditLogFormat json
			SecAuditLogParts ABCFHZ
			SecAction "id:900000,phase:1,pass,t:none,nolog,setvar:tx.paranoia_level=1"
			SecAction "id:900110,phase:1,pass,t:none,nolog,setvar:tx.inbound_anomaly_score_threshold=15,setvar:tx.outbound_anomaly_score_threshold=15"
			`
		}
	}
	handle_errors 400 403 429 {
		root * /etc/caddy/errors
		templates
		rewrite * /error.html
		file_server
	}
}

(waf_strict) {
	@not_websocket_strict {
		not header Connection *Upgrade*
	}
	route @not_websocket_strict {
		coraza_waf {
			load_owasp_crs
			directives `
			Include /etc/caddy/coraza/pre-crs.conf
			Include /data/coraza/custom-pre-crs.conf
			Include @crs-setup.conf.example
			Include @owasp_crs/*.conf
			Include /etc/caddy/coraza/post-crs.conf
			Include /data/coraza/custom-post-crs.conf
			SecRuleEngine On
			SecAuditEngine RelevantOnly
			SecAuditLog /var/log/coraza-audit.log
			SecAuditLogFormat json
			SecAuditLogParts ABCFHZ
			SecAction "id:900000,phase:1,pass,t:none,nolog,setvar:tx.paranoia_level=1"
			SecAction "id:900110,phase:1,pass,t:none,nolog,setvar:tx.inbound_anomaly_score_threshold=5,setvar:tx.outbound_anomaly_score_threshold=4"
			`
		}
	}
	handle_errors 400 403 429 {
		root * /etc/caddy/errors
		templates
		rewrite * /error.html
		file_server
	}
}

(waf_off) {
	# No WAF processing — placeholder snippet for services that don't need it.
}

# Configurable rate limit — per client IP, excludes WebSocket upgrades
# Sets X-RateLimit-Limit and X-RateLimit-Policy headers on all responses.
# The plugin automatically sets Retry-After on 429 responses.
# Usage: import rate_limit <zone_name> <events> <window>
# Example: import rate_limit sonarr 100 1m
(rate_limit) {
	rate_limit {
		zone {args[0]} {
			match {
				not header Connection *Upgrade*
			}
			key {http.request.remote.host}
			events {args[1]}
			window {args[2]}
		}
	}
	header X-RateLimit-Limit "{args[1]}"
	header X-RateLimit-Policy "{args[1]};w={args[2]};name=\"{args[0]}\""
}

# Common TLS config snippet
(tls_config) {
	tls {
		issuer acme {
			dns cloudflare {$CF_API_TOKEN}
			propagation_delay 60s
			propagation_timeout -1
			resolvers 1.1.1.1
		}
	}
}

# Standard log config — INFO level, per-site log file
(site_log) {
	log {
		level INFO
		output file /var/log/{args[0]}-access.log {
			roll_size 256mb
			roll_keep 5
			roll_keep_for 168h
		}
		format json {
			time_format wall
		}
	}
}

# IPsum blocklist — auto-generated file with @ipsum_blocked matcher + abort
# Updated daily by scripts/update-ipsum.sh via cron
# Usage: import ipsum_blocklist
(ipsum_blocklist) {
	import /etc/caddy/ipsum_block.caddy
}

# Authelia forward auth — applied to protected services
# Usage: import forward_auth
(forward_auth) {
	forward_auth 172.19.99.2:9091 {
		uri /api/authz/forward-auth
		copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
	}
}

# Common reverse proxy headers snippet
(proxy_headers) {
	trusted_proxies private_ranges
	header_up X-Forwarded-For {client_ip}
	header_down -Access-Control-Allow-Origin
	header_down -Access-Control-Allow-Methods
	header_down -Access-Control-Allow-Headers
	header_down -Access-Control-Max-Age
}

# Custom error pages — serves /etc/caddy/errors/error.html with Caddy templates
# Covers remaining error codes not handled by the (waf) snippet.
# The (waf) snippet handles 403 and 429 specifically; this catches the rest
# (404, 500, 502, 503, 504, etc.)
# Usage: import error_pages
(error_pages) {
	handle_errors {
		root * /etc/caddy/errors
		templates
		rewrite * /error.html
		file_server
	}
}

# caddy.erfi.io — Admin API is localhost-only.
# Use `docker exec caddy caddy reload --config /etc/caddy/Caddyfile` to reload.
# Or SSH tunnel: ssh -L 2019:localhost:2019 user@host
caddy.erfi.io {
	import cors
	import security_headers
	import ipsum_blocklist
	import rate_limit caddy 100 1m
	import tls_config
	encode zstd gzip
	respond "Caddy is running. Admin API available via localhost:2019 only." 200
	import error_pages
	import site_log caddy-api
}

waf.erfi.io {
	import cors
	import security_headers
	import forward_auth
	import ipsum_blocklist
	import rate_limit waf 200 1m
	import tls_config
	encode zstd gzip
	handle /api/* {
		reverse_proxy 172.19.98.2:8080 {
			import proxy_headers
		}
	}
	# Fallback: auth redirects and HTML get no-store (prevents Cloudflare/browser caching 302s)
	header ?Cache-Control "no-store"
	handle {
		root * /etc/caddy/waf-ui
		# Hashed assets are immutable — only reached after forward_auth succeeds
		@waf_hashed path /_astro/*
		header @waf_hashed Cache-Control "public, max-age=31536000, immutable"
		try_files {path} {path}/index.html /index.html
		file_server
	}
	import error_pages
	import site_log waf
}

authelia.erfi.io {
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit authelia 200 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.99.2:9091 {
		import proxy_headers
	}
	import error_pages
	import site_log authelia
}

servarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit servarr 1000 1m
	import tls_config
	import forward_auth
	encode zstd gzip
	reverse_proxy localhost:90 {
		import proxy_headers
	}
	import error_pages
	import site_log servarr
}

sonarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit sonarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.3:8989 {
		import proxy_headers
	}
	import error_pages
	import site_log sonarr
}

radarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit radarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.2:7878 {
		import proxy_headers
	}
	import error_pages
	import site_log radarr
}

bazarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit bazarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.4:6767 {
		import proxy_headers
	}
	import error_pages
	import site_log bazarr
}

vault.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit vault 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.4.2:80 {
		import proxy_headers
		header_up X-Real-IP {remote_host}
	}
	import error_pages
	import site_log vaultwarden
}

prowlarr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit prowlarr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.10:9696 {
		import proxy_headers
	}
	import error_pages
	import site_log prowlarr
}

jellyfin.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit jellyfin 1000 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.15:8096 {
		import proxy_headers
	}
	import error_pages
	import site_log jellyfin
}

qbit.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf_moderate
	import ipsum_blocklist
	import rate_limit qbit 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.22:8080 {
		import proxy_headers
	}
	import error_pages
	import site_log qbit
}

change.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import forward_auth
	import rate_limit change 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.3.2:5000 {
		import proxy_headers
	}
	import error_pages
	import site_log change
}

seerr.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit seerr 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.21:5055 {
		import proxy_headers
	}
	import error_pages
	import site_log seerr
}

keycloak.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit keycloak 100 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.12.2:8080 {
		import proxy_headers
	}
	import error_pages
	import site_log keycloak
}

joplin.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit joplin 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.13.2:22300 {
		import proxy_headers
	}
	import error_pages
	import site_log joplin
}

navidrome.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit navidrome 1000 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.17:4533 {
		import proxy_headers
	}
	import error_pages
	import site_log navidrome
}

sabnzbd.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit sabnzbd 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.1.19:6666 {
		import proxy_headers
	}
	import error_pages
	import site_log sabnzbd
}

immich.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit immich 1000 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.22.2:2283 {
		import proxy_headers
	}
	import error_pages
	import site_log immich
}

caddy-prometheus.erfi.io {
	import cors
	import security_headers
	import waf_off
	import ipsum_blocklist
	import rate_limit caddy-prometheus 100 1m
	import tls_config
	import forward_auth
	encode zstd gzip
	reverse_proxy /metrics localhost:2019 {
		import proxy_headers
	}
	import error_pages
	import site_log caddy-prometheus
}

copyparty.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf
	import ipsum_blocklist
	import rate_limit copyparty 300 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.66.2:3923 {
		import proxy_headers
	}
	import error_pages
	import site_log copyparty
}

dockge-sg.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf_moderate
	import ipsum_blocklist
	import rate_limit dockge 100 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.17.0.2:5001 {
		import proxy_headers
	}
	import error_pages
	import site_log dockge
}

httpbun.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf_strict
	import ipsum_blocklist
	import rate_limit httpbun 100 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.15.2:80 {
		import proxy_headers
	}
	import error_pages
	import site_log httpbun
}

httpbin.erfi.io {
	import cors
	import security_headers
	import static_cache
	import waf_strict
	import ipsum_blocklist
	import rate_limit httpbin 100 1m
	import tls_config
	encode zstd gzip
	reverse_proxy 172.19.15.3:80 {
		import proxy_headers
	}
	import error_pages
	import site_log httpbin
}

# Internal admin API proxy — allows waf-api to trigger Caddy reloads.
# Restricted to the waf-api Docker subnet (172.19.98.0/24).
:2020 {
	@allowed remote_ip 172.19.98.0/24
	handle @allowed {
		reverse_proxy localhost:2019
	}
	handle {
		respond "Forbidden" 403
	}
}
