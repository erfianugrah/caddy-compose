# Pre-CRS configuration — loaded BEFORE OWASP CRS
# Replaces @coraza.conf-recommended with manual settings so we can
# control body processing. The key difference: we do NOT enable the
# XML body processor (rule 200000 from recommended), keeping
# REQUEST_BODY available as raw text for regex-based XXE detection.
# JSON body processor IS enabled — it doesn't interfere with XXE rules
# and is needed for CRS to properly inspect JSON payloads.
#
# Rule IDs used:
#   200001, 200002, 200003, 200006 — from @coraza.conf-recommended
#   9100003, 9100006 — custom XXE rules

# ── Engine & request body settings ──────────────────────────────────
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject

# ── JSON body processor (from @coraza.conf-recommended) ─────────────
# Initiate JSON processor for application/json content type
SecRule REQUEST_HEADERS:Content-Type "^application/json" \
    "id:'200001',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

# JSON processor for +json subtypes (e.g. application/vnd.api+json)
SecRule REQUEST_HEADERS:Content-Type "^application/[a-z0-9.-]+[+]json" \
    "id:'200006',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

# NOTE: XML body processor (rule 200000) is intentionally OMITTED.
# It would consume REQUEST_BODY into an XML parse tree, making
# regex-based XXE detection in rules 9100003/9100006 ineffective.

# ── Request body error handling (from @coraza.conf-recommended) ─────
# Deny requests with unparseable bodies (catches malformed POST data)
SecRule REQBODY_ERROR "!@eq 0" \
    "id:'200002',phase:2,t:none,log,deny,status:400,\
    msg:'Failed to parse request body.',\
    logdata:'%{reqbody_error_msg}',severity:2"

# Deny requests failing multipart strict validation (catches evasion)
SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
    "id:'200003',phase:2,t:none,log,deny,status:400,\
    msg:'Multipart request body failed strict validation.'"

# ── Response body settings ──────────────────────────────────────────
# Disabled: response body inspection buffers entire responses, which breaks
# large JSON APIs (e.g. radarr /api/v3/movie returning 500+ entries).
# Data leak detection (outbound rules) is less useful for a homelab.
SecResponseBodyAccess Off

# ── Persistent data directory ───────────────────────────────────────
SecDataDir /tmp/

# ── Socket.io exclusion ─────────────────────────────────────────────
# Socket.io long-polling sends text/plain bodies, which CRS rule 920420
# rejects (content type not in allowed list). Skip that rule for socket.io paths.
SecRule REQUEST_URI "@beginsWith /socket.io/" \
    "id:9100001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920420"

# ── Custom XXE rules ────────────────────────────────────────────────
# These rely on raw REQUEST_BODY (no XML processor), which is why
# we omit rule 200000 above.

# XXE: DOCTYPE/ENTITY with SYSTEM or PUBLIC in request body
SecRule REQUEST_BODY "@rx (?i:<!(?:DOCTYPE|ENTITY)[^>]*(?:SYSTEM|PUBLIC))" \
    "id:9100003,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XXE: DOCTYPE/ENTITY with SYSTEM or PUBLIC detected in body',\
    tag:'attack-xxe',\
    tag:'custom-rules',\
    severity:'CRITICAL'"

# XXE: parameter entities (% in ENTITY declaration)
SecRule REQUEST_BODY "@rx (?i:<!ENTITY\s+%)" \
    "id:9100006,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XXE: parameter entity detected in body',\
    tag:'attack-xxe',\
    tag:'custom-rules',\
    severity:'CRITICAL'"
