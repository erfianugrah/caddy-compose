# Pre-CRS custom rules — loaded BEFORE OWASP CRS
# Rule IDs 9100000–9100009
#
# Replaces @coraza.conf-recommended with manual settings so we can
# control body processing. The key difference: we do NOT enable the
# XML body processor, keeping REQUEST_BODY available as raw text
# for regex-based XXE detection.

# --- Engine and body settings (replaces @coraza.conf-recommended) ---
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecResponseBodyAccess Off

# --- XXE: DOCTYPE/ENTITY with SYSTEM or PUBLIC in request body ---
SecRule REQUEST_BODY "@rx (?i:<!(?:DOCTYPE|ENTITY)[^>]*(?:SYSTEM|PUBLIC))" \
    "id:9100003,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XXE: DOCTYPE/ENTITY with SYSTEM or PUBLIC detected in body',\
    tag:'attack-xxe',\
    tag:'custom-rules',\
    severity:'CRITICAL'"

# --- XXE: parameter entities (% in ENTITY declaration) ---
SecRule REQUEST_BODY "@rx (?i:<!ENTITY\s+%)" \
    "id:9100006,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XXE: parameter entity detected in body',\
    tag:'attack-xxe',\
    tag:'custom-rules',\
    severity:'CRITICAL'"
