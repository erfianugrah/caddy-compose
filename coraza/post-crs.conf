# Post-CRS custom rules — loaded AFTER OWASP CRS
# These operate on ARGS, QUERY_STRING, REQUEST_HEADERS which are
# unaffected by the XML body processor.
# Rule IDs 9100010–9100099

# --- RCE: pipe to shell command ---
SecRule ARGS "@rx \|(?:id|cat|ls|whoami|curl|wget|bash|sh|nc|ncat|python[23]?|perl|ruby|php|node|tee|head|tail|less|more|dd|base64|xxd|rev|env|printenv|uname|hostname|passwd|shadow|ifconfig|ip )" \
    "id:9100010,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RCE: pipe to shell command detected',\
    tag:'attack-rce',\
    tag:'custom-rules',\
    severity:'CRITICAL'"

# --- RCE: backtick command substitution ---
SecRule ARGS "@rx `[^`]+`" \
    "id:9100011,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RCE: backtick command substitution detected',\
    tag:'attack-rce',\
    tag:'custom-rules',\
    severity:'CRITICAL'"

# --- HTTP Response Splitting: CRLF injection in query string ---
SecRule QUERY_STRING "@rx (?:%0[dD]%0[aA]|\r\n)" \
    "id:9100012,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'HTTP response splitting: CRLF injection in query string',\
    tag:'attack-protocol',\
    tag:'custom-rules',\
    severity:'CRITICAL'"

# --- HTTP Response Splitting: CRLF injection in request headers ---
SecRule REQUEST_HEADERS "@rx (?:%0[dD]%0[aA]|\r\n)" \
    "id:9100013,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'HTTP response splitting: CRLF injection in header',\
    tag:'attack-protocol',\
    tag:'custom-rules',\
    severity:'CRITICAL'"
