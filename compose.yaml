services:
  caddy:
    image: erfianugrah/caddy:1.28.0-2.10.2
    hostname: caddy
    container_name: caddy
    restart: unless-stopped
    network_mode: host
    read_only: true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "8"
          memory: 2048M
        reservations:
          cpus: "1.0"
          memory: 512M
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:2019/config/",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      authelia:
        condition: service_started
        restart: true
    volumes:
      # Caddyfile mounted from host — source of truth, survives restarts
      - /mnt/user/data/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - /mnt/user/data/caddy/site:/srv:ro
      - /mnt/user/data/caddy/data:/data
      - /mnt/user/data/caddy/config:/config
      - /mnt/user/data/caddy/log:/var/log
      # Dynamic WAF overrides — written by wafctl Policy Engine
      - /mnt/user/data/caddy/coraza:/data/coraza
      # Dynamic rate limit zone files — written by wafctl Rate Limit Engine
      - /mnt/user/data/caddy/rl:/data/caddy/rl
      # Temp dirs for read-only root filesystem
      - tmpfs_run:/tmp
      - tmpfs_caddy:/var/run
    environment:
      - TZ=Asia/Singapore
      - CF_API_TOKEN=${CF_API_TOKEN}
      - EMAIL=${EMAIL}

  authelia:
    image: docker.io/authelia/authelia:4.39
    hostname: authelia
    container_name: authelia
    restart: unless-stopped
    user: "1000:1000"
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--no-check-certificate",
          "--tries=1",
          "--spider",
          "http://localhost:9091/api/health",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      authelia:
        ipv4_address: 172.19.99.2
    volumes:
      - /mnt/user/data/authelia/config:/config
      # Authelia writes healthcheck metadata here at startup; bind-mount so read_only doesn't block it
      - /mnt/user/data/authelia/config/.healthcheck.env:/app/.healthcheck.env
      - /mnt/user/data/authelia/secrets:/secrets:ro
    tmpfs:
      - /tmp:size=32M
    environment:
      TZ: "Asia/Singapore"
      # Secrets — loaded from files for security (not visible in docker inspect/proc)
      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE: "/secrets/jwt_secret"
      AUTHELIA_SESSION_SECRET_FILE: "/secrets/session_secret"
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: "/secrets/storage_encryption_key"

  wafctl:
    build:
      context: wafctl
      dockerfile: Dockerfile
    image: erfianugrah/wafctl:0.21.0
    hostname: wafctl
    container_name: wafctl
    restart: unless-stopped
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 32M
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/api/health",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      waf:
        ipv4_address: 172.19.98.2
    extra_hosts:
      - "caddy:host-gateway"
    volumes:
      - /mnt/user/data/caddy/log:/var/log:ro
      - /mnt/user/data/wafctl:/data
      # Dynamic WAF overrides — shared with Caddy
      - /mnt/user/data/caddy/coraza:/data/coraza
      # Dynamic rate limit zone files — shared with Caddy
      - /mnt/user/data/caddy/rl:/data/rl
      # Caddyfile — read-only, needed for reload via admin API
      - /mnt/user/data/caddy/Caddyfile:/data/Caddyfile:ro
      # GeoIP MMDB database (DB-IP Lite or MaxMind GeoLite2)
      - /mnt/user/data/wafctl/geoip:/data/geoip:ro
    environment:
      - TZ=Asia/Singapore
      - WAF_AUDIT_LOG=/var/log/coraza-audit.log
      - WAF_EXCLUSIONS_FILE=/data/exclusions.json
      - WAF_CONFIG_FILE=/data/waf-config.json
      - WAF_RATELIMIT_FILE=/data/rate-limits.json
      - WAF_COMBINED_ACCESS_LOG=/var/log/combined-access.log
      - WAF_CORAZA_DIR=/data/coraza
      - WAF_RATELIMIT_DIR=/data/rl
      - WAF_CADDYFILE_PATH=/data/Caddyfile
      - WAF_CADDY_ADMIN_URL=http://caddy:2020
      - WAF_GEOIP_DB=/data/geoip/country.mmdb

networks:
  authelia:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.99.0/24
          gateway: 172.19.99.1
  waf:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.98.0/24
          gateway: 172.19.98.1

volumes:
  tmpfs_run:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=64m
  tmpfs_caddy:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=64m
